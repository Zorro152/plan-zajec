<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Plan zajęć – siatka + wybór</title>
<style>
  :root{--bd:#e5e7eb;--muted:#6b7280;--accent:#4f46e5;--hourHeight:48px}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7f8;color:#111}
  header{padding:10px 16px;background:#fff;border-bottom:1px solid var(--bd);position:sticky;top:0;z-index:5;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .leftHead{display:flex;gap:8px;align-items:center}
  .rightHead{display:flex;gap:8px;align-items:center}
  .btn{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .input{padding:6px 8px;border:1px solid var(--bd);border-radius:10px;background:#fff}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
  @media (max-width:960px){.wrap{grid-template-columns:1fr}}
  /* lewa */
  .panel{display:flex;flex-direction:column;gap:8px}
  .list{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:8px;max-height:68vh;overflow:auto}
  .courseRow{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--bd);border-radius:10px;padding:8px;margin:6px 0;background:#fafafa}
  .courseRow button{border:0;background:#10b981;color:#fff;border-radius:8px;padding:4px 10px;cursor:pointer}
  .muted{color:var(--muted);font-size:12px}
  /* prawa */
  .right{display:flex;flex-direction:column;gap:12px}
  .gridWrap{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:8px}
  .gridHeader{display:grid;grid-template-columns:60px repeat(5,1fr);gap:4px;padding:4px 0}
  .gridHeader div{font-size:12px;font-weight:600;text-align:center}
  .gridBody{display:grid;grid-template-columns:60px repeat(5,1fr);gap:4px}
  .times{position:relative}
  .timeCell{height:calc(var(--hourHeight)/2);font-size:11px;color:var(--muted);text-align:right;padding-right:6px;border-right:1px solid var(--bd)}
  .dayCol{position:relative;border-left:1px solid var(--bd);background:
      repeating-linear-gradient(to bottom, transparent, transparent calc(var(--hourHeight)/2 - 1px), rgba(0,0,0,0.05) calc(var(--hourHeight)/2));
      min-height:calc(var(--hourHeight)*6)}
  .event{position:absolute;border:1px solid #c7d2fe;background:#eef2ff;border-radius:8px;padding:4px;font-size:11px;overflow:hidden;cursor:pointer}
  .event strong{display:block;margin-bottom:2px;font-size:12px}
  .selectedWrap{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:10px}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px}
  .card{border:1px solid var(--bd);border-radius:12px;padding:8px;background:#fafafa}
  .cardHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .chip{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:9999px;padding:2px 8px;font-size:11px}
  .close{border:0;background:#ef4444;color:#fff;border-radius:8px;padding:2px 8px;cursor:pointer}
  fieldset{border:1px solid var(--bd);border-radius:10px;padding:6px;margin:6px 0;background:#fff}
  legend{font-weight:600;font-size:12px}
  .opt{display:flex;gap:8px;align-items:flex-start;margin:4px 0;font-size:13px}
</style>
</head>
<body>
<header>
  <div class="leftHead">
    <button id="exportCSV" class="btn">Eksport CSV</button>
    <button id="exportPDF" class="btn">Eksport PDF</button>
  </div>
  <div class="rightHead">
    <button id="clearAll" class="btn">Wyczyść</button>
  </div>
</header>

<div style="padding:12px 16px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
  <input id="src" class="input" style="width:420px" placeholder="Wklej źródło (np. &lt;tr&gt;...)" />
  <button id="parseBtn" class="btn primary">Parsuj</button>
</div>

<div class="wrap">
  <!-- LEWA: szukaj + lista -->
  <aside class="panel">
    <input id="search" class="input" placeholder="Szukaj: nazwa / prowadzący / dzień / godzina / sala / uwagi" />
    <div id="courseList" class="list"></div>
  </aside>

  <!-- PRAWA: siatka + kafelki -->
  <section class="right">
    <div class="gridWrap">
      <div id="gridHeader" class="gridHeader"></div>
      <div id="gridBody" class="gridBody"></div>
    </div>

    <div class="selectedWrap">
      <h3 style="margin:0 0 8px">Wybrane przedmioty</h3>
      <div id="selectedCards" class="cards"></div>
    </div>
  </section>
</div>

<script>
/* ===== Utils ===== */
const DAYS=['poniedziałek','wtorek','środa','czwartek','piątek'];
const norm=s=>(s||'').replace(/\s+/g,' ').replace(/—/g,'-').trim();
function htmlToText(node){const d=document.createElement('div');d.innerHTML=node?.innerHTML||'';d.querySelectorAll('a').forEach(a=>a.outerHTML=a.textContent);return norm(d.textContent);}
function toMinutes(span){if(!span)return null;const s=span.replace(/[—–]/g,'-').replace(/\s+/g,'').replace(/:/g,'.');const m=s.match(/^(\d{1,2})(?:\.(\d{1,2}))?-(\d{1,2})(?:\.(\d{1,2}))?$/);const toMin=(h,x)=>+h*60+(+x||0);return m?{start:toMin(m[1],m[2]),end:toMin(m[3],m[4])}:null;}
function sectionCol(s){const L=(s||'').toLowerCase();if(L.includes('(o)')||L.includes('obowiązkowe'))return 'O';if(L.includes('(m)')||L.includes('zaawansowane'))return 'M';return 'REST';}
function bucketType(t){const v=(t||'').toLowerCase();if(v.startsWith('wyk')||v.startsWith('konw'))return 'wykład';if(v.startsWith('cw'))return 'ćwiczenia';if(v.startsWith('lab'))return 'laboratorium';if(v.startsWith('sem'))return 'seminarium';return 'inne';}

/* ===== Parsing ===== */
function parse(html){
  const wrapped=/<tr/i.test(html)&&!/<table/i.test(html)?`<table>${html}</table>`:html;
  const dom=new DOMParser().parseFromString(wrapped,'text/html');
  const rows=[...dom.querySelectorAll('tr')];
  let section=null,current=null;const out=[];
  for(const tr of rows){
    if(tr.classList.contains('top')){section=norm(tr.textContent);continue;}
    const a=tr.querySelector('td[colspan="8"] a');
    if(a){current={name:norm(a.textContent),link:a.getAttribute('href')||'',section,entries:[]};out.push(current);continue;}
    const tds=tr.querySelectorAll('td');if(!tds.length)continue;
    const e={group:norm(tds[0]?.textContent),type:norm(tds[1]?.textContent),teacher:norm(tds[2]?.textContent),
             day:norm(tds[3]?.textContent),time:norm(tds[4]?.textContent),room:norm(tds[5]?.textContent),
             uwagi:[tds[6]?htmlToText(tds[6]):'',tds[7]?htmlToText(tds[7]):''].filter(Boolean).join(' | ')};
    const empty=[e.group,e.type,e.teacher,e.day,e.time,e.room,e.uwagi].every(v=>!v||v==='.'); if(empty)continue;
    if(!current){current={name:'Inne',link:'',section,entries:[]};out.push(current);}
    current.entries.push(e);
  }
  return out;
}

/* ===== Global state ===== */
let ALL_COURSES=[];                   // sparsowane kursy
const SELECTED=new Map();             // nazwa -> { bucket: entry | [entries...] }
const COURSE_BY_NAME=new Map();       // nazwa -> course (z link)

function buildIndex(courses){COURSE_BY_NAME.clear();courses.forEach(c=>COURSE_BY_NAME.set(c.name,c));}

/* ===== Left list ===== */
function renderCourseList(){
  const list=document.getElementById('courseList'); list.innerHTML='';
  const q=(document.getElementById('search').value||'').toLowerCase().trim();
  const filtered=ALL_COURSES.filter(c=>{
    const hay=[c.name,c.section,c.link,...(c.entries||[]).flatMap(e=>[e.type,e.teacher,e.day,e.time,e.room,e.uwagi])].join(' ').toLowerCase();
    return hay.includes(q);
  }).sort((a,b)=>sectionCol(a.section).localeCompare(sectionCol(b.section))||a.name.localeCompare(b.name));
  for(const c of filtered){
    const row=document.createElement('div');row.className='courseRow';
    row.innerHTML=`<div><strong>${c.name}</strong><div class="muted">${c.section||''}</div></div><button>+</button>`;
    row.querySelector('button').onclick=()=>addCourse(c);
    list.appendChild(row);
  }
}
document.getElementById('search').addEventListener('input',renderCourseList);

/* ===== Auto-select logic ===== */
function autoSelectIfSingle(course){
  // podziel entries na wiadra
  const byBucket={}; (course.entries||[]).forEach(e=>{const b=bucketType(e.type);(byBucket[b]||(byBucket[b]=[])).push(e);});
  const state=SELECTED.get(course.name)||{};
  // wykład/konwersatorium: zbiorczo – jeśli istnieją, zawsze można dodać wszystkie
  if(byBucket['wykład']?.length){ state['wykład']=byBucket['wykład'].slice(); }
  // ćwiczenia: jeśli dokładnie 1 opcja łącznie → ustaw
  if((byBucket['ćwiczenia']||[]).length===1){ state['ćwiczenia']=byBucket['ćwiczenia'][0]; }
  // laboratorium: jeśli dokładnie 1 opcja → ustaw
  if((byBucket['laboratorium']||[]).length===1){ state['laboratorium']=byBucket['laboratorium'][0]; }
  // seminarium: jeśli dokładnie 1 opcja → ustaw
  if((byBucket['seminarium']||[]).length===1){ state['seminarium']=byBucket['seminarium'][0]; }
  // przypadki z opisu automatyki będą objęte tymi regułami
  SELECTED.set(course.name,state);
}

/* ===== Add / remove course ===== */
function addCourse(course){
  if(!SELECTED.has(course.name)){
    SELECTED.set(course.name,{});
    autoSelectIfSingle(course); // automatyczny wybór gdy jednoznaczny
    renderSelectedCards();
    renderGrid();
  }
}
function removeCourse(name){
  SELECTED.delete(name);
  renderSelectedCards();
  renderGrid();
}

/* ===== Selected cards (choices under grid) ===== */
function renderSelectedCards(){
  const wrap=document.getElementById('selectedCards'); wrap.innerHTML='';
  const selectedCourses=[...SELECTED.keys()].map(n=>COURSE_BY_NAME.get(n)).filter(Boolean);
  for(const c of selectedCourses){
    // grupowanie
    const byBucket={}; (c.entries||[]).forEach(e=>{const b=bucketType(e.type);(byBucket[b]||(byBucket[b]=[])).push(e);});
    const card=document.createElement('div');card.className='card';
    const tag=Object.entries(byBucket).map(([k,v])=>`${k}: ${v.length}`).join(' · ');
    card.innerHTML=`
      <div class="cardHead">
        <div><strong>${c.name}</strong> <span class="chip">${tag}</span> ${c.link?`· <a href="${c.link}" target="_blank" class="muted">USOS</a>`:''}</div>
        <button class="close" title="Usuń">✕</button>
      </div>
      <div class="body"></div>`;
    card.querySelector('.close').onclick=()=>removeCourse(c.name);
    const body=card.querySelector('.body');

    // wykład/konw – jedna zbiorcza opcja
    if(byBucket['wykład']?.length){
      const list=byBucket['wykład'];
      const idb=Math.random().toString(36).slice(2,8);
      const fs=document.createElement('fieldset');
      fs.innerHTML=`
        <legend>wykład/konwersatorium</legend>
        <div class="opt"><input type="radio" name="${c.name}_wyk_${idb}" id="${idb}_all"><label for="${idb}_all"><strong>Dodaj wszystkie terminy</strong> <small>(${list.length})</small></label></div>
        <div class="opt"><input type="radio" name="${c.name}_wyk_${idb}" id="${idb}_none"><label for="${idb}_none"><em>brak</em></label></div>
        <div class="muted" style="margin-left:22px">${list.map(e=>`• ${[e.teacher,e.day,e.time,e.room&&('s.'+e.room)].filter(Boolean).join(' · ')}`).join('<br>')}</div>`;
      fs.querySelector(`#${idb}_all`).onchange=()=>{const st=SELECTED.get(c.name)||{};st['wykład']=list.slice();SELECTED.set(c.name,st);renderGrid();};
      fs.querySelector(`#${idb}_none`).onchange=()=>{const st=SELECTED.get(c.name)||{};delete st['wykład'];Object.keys(st).length?SELECTED.set(c.name,st):SELECTED.delete(c.name);renderSelectedCards();renderGrid();};
      // zaznacz, jeśli już wybrane
      if(Array.isArray((SELECTED.get(c.name)||{})['wykład'])) fs.querySelector(`#${idb}_all`).checked=true; else fs.querySelector(`#${idb}_none`).checked=true;
      body.appendChild(fs);
    }

    // ćwiczenia / lab / sem – jedna ramka, jedna opcja
    for(const bucket of ['ćwiczenia','laboratorium','seminarium']){
      const list=byBucket[bucket]; if(!list?.length) continue;
      const idb=Math.random().toString(36).slice(2,8);
      const fs=document.createElement('fieldset'); fs.innerHTML=`<legend>${bucket}</legend>`;
      fs.innerHTML+=list.map((e,i)=>`
        <div class="opt">
          <input type="radio" name="${c.name}_${bucket}_${idb}" id="${idb}_${i}">
          <label for="${idb}_${i}">${[e.teacher,e.day,e.time,e.room&&('s.'+e.room),e.group&&('gr.'+e.group)].filter(Boolean).join(' · ')} ${e.uwagi?`<small>(${e.uwagi})</small>`:''}</label>
        </div>`).join('');
      fs.innerHTML+=`<div class="opt"><input type="radio" name="${c.name}_${bucket}_${idb}" id="${idb}_none"><label for="${idb}_none"><em>brak</em></label></div>`;
      // stan
      const sel=(SELECTED.get(c.name)||{})[bucket];
      if(sel){ const idx=list.findIndex(x=>x===sel); if(idx>=0) fs.querySelector(`#${idb}_${idx}`).checked=true; else fs.querySelector(`#${idb}_none`).checked=true; }
      else fs.querySelector(`#${idb}_none`).checked=true;
      // handlers
      fs.querySelectorAll(`input[name="${c.name}_${bucket}_${idb}"]`).forEach((inp,idx)=>{
        inp.onchange=()=>{
          const st=SELECTED.get(c.name)||{};
          if(inp.id.endsWith('_none')){ delete st[bucket]; Object.keys(st).length?SELECTED.set(c.name,st):SELECTED.delete(c.name); renderGrid(); return; }
          st[bucket]=list[idx]; SELECTED.set(c.name,st); renderGrid();
        };
      });
      body.appendChild(fs);
    }
    wrap.appendChild(card);
  }
}

/* ===== Grid (excel-like) ===== */
function collectEvents(){
  const map=Object.fromEntries(DAYS.map(d=>[d,[]]));
  SELECTED.forEach((byBucket,course)=>{
    const courseLink=(COURSE_BY_NAME.get(course)||{}).link||'';
    for(const [bucket,val] of Object.entries(byBucket)){
      const arr=Array.isArray(val)?val:[val];
      arr.forEach(e=>{
        if(!e||!e.day) return;
        const key=DAYS.find(d=>d.toLowerCase()===e.day.toLowerCase()); if(!key) return;
        const tm=toMinutes(e.time)||{start:null,end:null};
        map[key].push({course,courseLink,bucket,time:e.time,start:tm.start,end:tm.end,teacher:e.teacher,room:e.room,group:e.group,uwagi:e.uwagi});
      });
    }
  });
  return map;
}
function renderGrid(){
  const header=document.getElementById('gridHeader'), body=document.getElementById('gridBody');
  header.innerHTML=''; body.innerHTML='';
  const eventsByDay=collectEvents();

  // zakres godzin
  let minStart=8*60, maxEnd=12*60;
  for(const d of DAYS){ for(const ev of eventsByDay[d]){ if(ev.start!=null) minStart=Math.min(minStart,ev.start); if(ev.end!=null) maxEnd=Math.max(maxEnd,ev.end); } }
  minStart=Math.min(minStart,8*60);
  minStart=Math.floor(minStart/60)*60;
  maxEnd=Math.max(Math.ceil(maxEnd/60)*60,12*60);

  // Header
  header.appendChild(document.createElement('div'));
  DAYS.forEach(d=>{const cell=document.createElement('div');cell.textContent=d;header.appendChild(cell);});

  // Kolumna czasu co 30 min
  const timesCol=document.createElement('div');timesCol.className='times';
  for(let m=minStart;m<=maxEnd;m+=30){const t=document.createElement('div');t.className='timeCell';t.textContent=(m%60===0)?String(Math.floor(m/60)).padStart(2,'0')+':00':'';timesCol.appendChild(t);}
  body.appendChild(timesCol);

  // Dni
  const totalMinutes=maxEnd-minStart;
  DAYS.forEach(day=>{
    const col=document.createElement('div');col.className='dayCol';
    col.style.height=`calc(${totalMinutes/60} * var(--hourHeight))`;
    body.appendChild(col);

    // lanes
    const evs=eventsByDay[day].filter(e=>e.start!=null&&e.end!=null).sort((a,b)=>a.start-b.start);
    const lanes=[];const placed=[];
    for(const ev of evs){let idx=lanes.findIndex(l=>l.end<=ev.start); if(idx===-1){idx=lanes.length;lanes.push({end:ev.end});} else {lanes[idx].end=ev.end;} placed.push({ev,lane:idx});}
    const laneCount=Math.max(1,lanes.length);

    placed.forEach(({ev,lane})=>{
      const top=((ev.start-minStart)/totalMinutes)*100;
      const ht=((ev.end-ev.start)/totalMinutes)*100;
      const left=(lane/laneCount)*100;
      const wid=(1/laneCount)*100-1;
      const box=document.createElement('div');box.className='event';
      box.style.top=`${top}%`; box.style.height=`${ht}%`; box.style.left=`${left}%`; box.style.width=`${wid}%`;
      const meta=[ev.teacher,ev.room&&('s.'+ev.room),ev.group&&('gr.'+ev.group)].filter(Boolean).join(' · ');
      box.innerHTML=`<strong>${ev.course}</strong>${ev.time||'—'}<br>${meta}${ev.uwagi?`<br><em>${ev.uwagi}</em>`:''}`;
      if(ev.courseLink){ box.addEventListener('click',()=>window.open(ev.courseLink,'_blank')); }
      col.appendChild(box);
    });
  });
}

/* ===== Export / Clear ===== */
function exportCSV(){
  const rows=[['Dzień','Godziny','Przedmiot','Typ','Prowadzący','Sala','Grupa','Uwagi','USOS']];
  const events=collectEvents();
  for(const d of DAYS){
    events[d].sort((a,b)=>(a.start??0)-(b.start??0));
    for(const ev of events[d]){
      rows.push([d,ev.time||'',ev.course,ev.bucket,ev.teacher||'',ev.room||'',ev.group||'',ev.uwagi||'',ev.courseLink||'']);
    }
  }
  const csv=rows.map(r=>r.map(v=>{
    const s=String(v??'');
    return /[",;\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;
  }).join(';')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='plan.csv';document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
}
function exportPDF(){ window.print(); }
function clearAll(){ SELECTED.clear(); renderSelectedCards(); renderGrid(); }

/* ===== Wire up ===== */
document.getElementById('parseBtn').onclick=()=>{
  const html=document.getElementById('src').value||'';
  ALL_COURSES=parse(html); buildIndex(ALL_COURSES);
  SELECTED.clear();
  renderCourseList();
  renderSelectedCards();
  renderGrid();
};
document.getElementById('exportCSV').onclick=exportCSV;
document.getElementById('exportPDF').onclick=exportPDF;
document.getElementById('clearAll').onclick=clearAll;

// init
renderCourseList(); renderGrid();
</script>
</body>
</html>
