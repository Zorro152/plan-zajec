<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plan zajęć – parser z podziałem</title>
  <style>
    :root{--gap:14px}
    body{font-family:sans-serif;margin:20px;background:#f7f7f8;color:#111}
    .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="text"]{flex:1;min-width:260px;padding:6px 8px;border:1px solid #ccc;border-radius:8px}
    button{padding:6px 12px;border:0;border-radius:8px;background:#4f46e5;color:#fff;cursor:pointer}
    .muted{color:#666;font-size:12px;margin:10px 0}
    .grid{display:grid;gap:var(--gap)}
    /* 3 kolumny na desktopie, 1 na mobile */
    @media (min-width: 980px){ .grid{grid-template-columns: 1fr 1fr 1fr;} }
    @media (max-width: 979px){ .grid{grid-template-columns: 1fr;} }
    .col{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;min-height:80px}
    .col h2{font-size:16px;margin:0 0 8px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin:8px 0}
    .row{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:6px;margin:4px 0;font-size:14px}
    details>summary{cursor:pointer;list-style:none;display:flex;gap:6px;align-items:center}
    summary::-webkit-details-marker{display:none}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:9999px;padding:2px 6px;font-size:12px;margin-left:6px}
    .col .empty{color:#777;font-size:13px}
  </style>
</head>
<body>
  <h1>Plan zajęć – parser z podziałem</h1>

  <div class="topbar">
    <input id="src" type="text" placeholder="Wklej tu fragment HTML (np. &lt;tr&gt;...&lt;/tr&gt;)" />
    <button id="parseBtn">Parsuj</button>
  </div>

  <div id="status" class="muted">Gotowe do parsowania.</div>

  <div class="grid">
    <section id="col-O" class="col">
      <h2>Przedmioty obowiązkowe (O)</h2>
      <div class="list"></div>
    </section>
    <section id="col-M" class="col">
      <h2>Zaawansowane przedmioty do wyboru (M)</h2>
      <div class="list"></div>
    </section>
    <section id="col-REST" class="col">
      <h2>Pozostałe</h2>
      <div class="list"></div>
    </section>
  </div>

<script>
const srcEl   = document.getElementById('src');
const statusEl= document.getElementById('status');

function norm(s){ return (s||'').replace(/\s+/g,' ').replace(/—/g,'-').trim(); }
function htmlToText(node){
  const d = document.createElement('div');
  d.innerHTML = node?.innerHTML || '';
  d.querySelectorAll('a').forEach(a => a.outerHTML = `${a.textContent}${a.href ? ` (${a.href})` : ''}`);
  return norm(d.textContent);
}

/** Zwraca obiekt: { name, link, entries:[], sectionLabel } */
function parsePlan(html){
  // jeśli wklejone są same <tr>, owińmy w <table>
  const wrapped = /<tr[\s>]/i.test(html) && !/<table[\s>]/i.test(html) ? `<table>${html}</table>` : html;
  const dom = new DOMParser().parseFromString(wrapped,'text/html');
  const rows = Array.from(dom.querySelectorAll('tr'));

  const courses=[]; let current=null; let section=null;

  for(const tr of rows){
    const isHeader = tr.classList.contains('top');
    const anchor = tr.querySelector('td[colspan="8"] > a');

    if(isHeader){
      // zapamiętaj aktualną sekcję (np. „Przedmioty obowiązkowe (O)”)
      const label = norm(tr.textContent);
      if(label) section = label;
      continue;
    }

    if(anchor){
      // nowy przedmiot
      current = {
        name: norm(anchor.textContent),
        link: anchor.getAttribute('href') || '',
        sectionLabel: section || '',
        entries: []
      };
      courses.push(current);
      continue;
    }

    const tds = tr.querySelectorAll('td');
    if(!tds.length) continue;

    const group   = norm(tds[0]?.textContent);
    const type    = norm(tds[1]?.textContent);
    const teacher = norm(tds[2]?.textContent);
    const day     = norm(tds[3]?.textContent);
    const time    = norm(tds[4]?.textContent);
    const room    = norm(tds[5]?.textContent);
    const uw1     = tds[6] ? htmlToText(tds[6]) : '';
    const uw2     = tds[7] ? htmlToText(tds[7]) : '';
    const empty   = [group,type,teacher,day,time,room,uw1,uw2].every(v=>v===''||v==='.');
    if(empty) continue;

    if(!current){
      current = { name:'Inne', link:'', sectionLabel: section || '', entries:[] };
      courses.push(current);
    }

    current.entries.push({
      group, type, teacher, day, time, room,
      uwagi: [uw1,uw2].filter(Boolean).join(' | ')
    });
  }
  return courses;
}

/** Mapowanie sekcji na kolumny: O / M / REST */
function sectionToColumn(label){
  const L = (label||'').toLowerCase();
  if (/\(o\)/i.test(label) || L.includes('obowiązkowe')) return 'O';
  if (/\(m\)/i.test(label) || L.includes('zaawansowane')) return 'M';
  return 'REST';
}

function renderColumn(containerId, courses){
  const root = document.querySelector(`#${containerId} .list`);
  root.innerHTML = '';
  if(!courses.length){
    root.innerHTML = '<div class="empty">Brak przedmiotów w tej kategorii.</div>';
    return;
  }

  for(const c of courses){
    const details=document.createElement('details');
    details.className='card';
    const counts=c.entries.reduce((a,e)=>{a[e.type||'inne']=(a[e.type||'inne']||0)+1;return a;},{});
    details.innerHTML=`
      <summary>
        <input type="checkbox" />
        <div><strong>${c.name}</strong>
          <span class="pill">${Object.entries(counts).map(([t,n])=>`${t}: ${n}`).join(' · ')}</span>
          ${c.link?`<div class="muted"><a href="${c.link}" target="_blank">USOS</a></div>`:''}
        </div>
      </summary>
      <div style="margin-top:6px">
        ${c.entries.map(e=>`
          <div class="row">
            <div><strong>${e.type||'—'}</strong>${e.group?` · gr. ${e.group}`:''}</div>
            <div>${[e.teacher,e.day,e.time,e.room&&('s. '+e.room)].filter(Boolean).join(' · ')}</div>
            ${e.uwagi?`<div class="muted">${e.uwagi}</div>`:''}
          </div>
        `).join('')}
      </div>
    `;
    // Checkbox = otwieranie/zamykanie (bez zapisywania stanu)
    const cb = details.querySelector('input[type="checkbox"]');
    cb.addEventListener('change', () => { details.open = cb.checked; });
    details.addEventListener('toggle', () => { cb.checked = details.open; });

    root.appendChild(details);
  }
}

function renderAll(courses){
  const byCol = { O:[], M:[], REST:[] };
  for(const c of courses){
    byCol[sectionToColumn(c.sectionLabel)].push(c);
  }
  renderColumn('col-O', byCol.O);
  renderColumn('col-M', byCol.M);
  renderColumn('col-REST', byCol.REST);
}

document.getElementById('parseBtn').onclick = () => {
  try{
    const html = srcEl.value || '';
    const courses = parsePlan(html);
    renderAll(courses);
    statusEl.textContent = `Parsowanie OK. Kursów: ${courses.length}`;
  }catch(e){
    console.error(e);
    statusEl.textContent = 'Błąd parsowania.';
    // wyczyść kolumny
    ['col-O','col-M','col-REST'].forEach(id=>{
      const root = document.querySelector(`#${id} .list`);
      if(root) root.innerHTML = '';
    });
  }
};
</script>
</body>
</html>
