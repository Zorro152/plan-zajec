<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Plan zajęć – wybór i plan</title>
<style>
  body{margin:0;font-family:sans-serif;background:#f7f7f8;color:#111}
  header{padding:12px 16px;background:#fff;border-bottom:1px solid #ddd;position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:18px}
  .container{display:grid;grid-template-columns:340px 1fr;gap:16px;padding:16px}
  @media(max-width:900px){.container{grid-template-columns:1fr}}

  /* lewa */
  .parsebar{display:flex;gap:6px;margin-bottom:8px}
  .parsebar input[type=text]{flex:1;padding:6px;border:1px solid #ccc;border-radius:6px}
  .parsebar button{padding:6px 10px;border:0;border-radius:6px;background:#4f46e5;color:#fff;cursor:pointer}
  .search{width:100%;padding:6px;border:1px solid #ccc;border-radius:6px;margin:6px 0}

  details.section{border:1px solid #ddd;border-radius:10px;background:#fff;margin:6px 0}
  details.section>summary{cursor:pointer;list-style:none;padding:8px 10px;font-weight:600}
  details.section>summary::-webkit-details-marker{display:none}
  .list{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:8px}
  @media(max-width:640px){.list{grid-template-columns:1fr}}

  .course{border:1px solid #ddd;border-radius:8px;background:#fafafa}
  .course header{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;font-size:14px;cursor:pointer}
  .course .body{display:none;padding:6px 8px}
  .course.open .body{display:block}
  .group{margin:4px 0}
  .group legend{font-weight:600;font-size:12px}
  .opt{margin:3px 0;font-size:13px}
  .opt label{cursor:pointer}

  /* prawa */
  .plan{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  @media(max-width:900px){.plan{grid-template-columns:1fr}}
  .day{border:1px solid #ddd;border-radius:8px;background:#fff;padding:6px}
  .day h3{margin:0 0 6px;font-size:14px}
  .slots{display:flex;flex-direction:column;gap:6px}
  .row{display:flex;gap:6px}
  .slot{flex:1;border:1px solid #ccc;border-radius:6px;background:#f9fafb;padding:4px;font-size:12px}
  .slot strong{display:block}
</style>
</head>
<body>
<header><h1>Plan zajęć – wybierz kursy</h1></header>
<div class="container">
  <aside>
    <div class="parsebar">
      <input id="src" type="text" placeholder="Wklej źródło &lt;tr&gt;..." />
      <button id="parseBtn">Parsuj</button>
    </div>
    <input id="search" type="search" class="search" placeholder="Szukaj (nazwa, prowadzący, dzień...)" />
    <details class="section" open><summary>Obowiązkowe (O)</summary><div id="col-O" class="list"></div></details>
    <details class="section" open><summary>Zaawansowane (M)</summary><div id="col-M" class="list"></div></details>
    <details class="section" open><summary>Pozostałe</summary><div id="col-REST" class="list"></div></details>
  </aside>
  <main>
    <h2>Plan</h2>
    <div id="plan" class="plan"></div>
  </main>
</div>

<script>
const DAYS = ['poniedziałek','wtorek','środa','czwartek','piątek'];

const norm=s=>(s||'').replace(/\s+/g,' ').trim();
function htmlToText(node){const d=document.createElement('div');d.innerHTML=node?.innerHTML||'';return norm(d.textContent);}
function parse(html){
  const wrapped=/<tr/i.test(html)&&!/<table/i.test(html)?`<table>${html}</table>`:html;
  const dom=new DOMParser().parseFromString(wrapped,'text/html');
  const rows=[...dom.querySelectorAll('tr')];
  let section=null,current=null;const out=[];
  for(const tr of rows){
    if(tr.classList.contains('top')){section=norm(tr.textContent);continue;}
    const a=tr.querySelector('td[colspan="8"] a');
    if(a){current={name:norm(a.textContent),link:a.href,section,entries:[]};out.push(current);continue;}
    const tds=tr.querySelectorAll('td');if(!tds.length)continue;
    const e={group:norm(tds[0]?.textContent),type:norm(tds[1]?.textContent),teacher:norm(tds[2]?.textContent),
             day:norm(tds[3]?.textContent),time:norm(tds[4]?.textContent),room:norm(tds[5]?.textContent),
             uwagi:[tds[6]?htmlToText(tds[6]):'',tds[7]?htmlToText(tds[7]):''].filter(Boolean).join(' | ')};
    if(Object.values(e).every(v=>!v||v==='.'))continue;
    if(!current){current={name:'Inne',link:'',section,entries:[]};out.push(current);}
    current.entries.push(e);
  }
  return out;
}
function bucketType(t){const v=(t||'').toLowerCase();if(v.startsWith('wyk')||v.startsWith('konw'))return 'wykład';if(v.startsWith('cw'))return 'ćwiczenia';if(v.startsWith('lab'))return 'laboratorium';if(v.startsWith('sem'))return 'seminarium';return 'inne';}
function sectionCol(s){const L=(s||'').toLowerCase();if(L.includes('(o)')||L.includes('obowiązkowe'))return 'O';if(L.includes('(m)')||L.includes('zaawansowane'))return 'M';return 'REST';}

const selections=new Map();
function renderCourses(courses){
  const cols={O:[],M:[],REST:[]};courses.forEach(c=>cols[sectionCol(c.section)].push(c));
  for(const key of['O','M','REST']){
    const root=document.getElementById('col-'+key);root.innerHTML='';
    cols[key].forEach(c=>{
      const card=document.createElement('div');card.className='course';
      card.innerHTML=`<header><span>${c.name}</span><button>+</button></header><div class="body"></div>`;
      const body=card.querySelector('.body');
      // grupowanie entries wg bucket + group
      const byBucket={};
      c.entries.forEach(e=>{
        const b=bucketType(e.type);
        if(b==='wykład'){ // scal wszystkie wykłady i konwersatoria razem wg group
          const g=e.group||'default';(byBucket[b]||(byBucket[b]={}))[g]=[...(byBucket[b]?.[g]||[]),e];
        }else{(byBucket[b]||(byBucket[b]={}))[e.group||'default']=[...(byBucket[b]?.[e.group||'default']||[]),e];}
      });
      Object.entries(byBucket).forEach(([bucket,groups])=>{
        Object.values(groups).forEach(list=>{
          const gId=Math.random().toString(36).slice(2,8);
          const fs=document.createElement('fieldset');fs.className='group';fs.innerHTML=`<legend>${bucket}</legend>`;
          fs.innerHTML+=list.map((e,i)=>`<div class="opt"><input type="radio" name="${c.name}_${bucket}_${gId}" id="${gId}_${i}"><label for="${gId}_${i}">${[e.teacher,e.day,e.time,e.room&&'s.'+e.room].filter(Boolean).join(' · ')}</label></div>`).join('');
          fs.innerHTML+=`<div class="opt"><input type="radio" name="${c.name}_${bucket}_${gId}" id="${gId}_none"><label for="${gId}_none"><em>brak</em></label></div>`;
          fs.querySelectorAll('input').forEach(inp=>inp.addEventListener('change',()=>{
            if(inp.id.endsWith('_none')){if(selections.has(c.name))delete selections.get(c.name)[bucket];renderPlan();return;}
            selections.set(c.name,selections.get(c.name)||{});
            selections.get(c.name)[bucket]=list;renderPlan();
          }));
          body.appendChild(fs);
        });
      });
      const toggle=card.querySelector('header button');
      toggle.addEventListener('click',()=>{card.classList.toggle('open');toggle.textContent=card.classList.contains('open')?'–':'+'});
      root.appendChild(card);
    });
  }
}
function mins(t){if(!t)return null;const m=t.match(/(\d{1,2})[.:](\d{1,2}).*?(\d{1,2})[.:](\d{1,2})/);if(!m)return null;return{start:+m[1]*60+ +m[2],end:+m[3]*60+ +m[4]};}
function renderPlan(){
  const plan=document.getElementById('plan');plan.innerHTML='';
  const daySlots={};DAYS.forEach(d=>daySlots[d]=[]);
  selections.forEach((byBucket,course)=>{for(const [bucket,list] of Object.entries(byBucket)){list.forEach(e=>{daySlots[e.day.toLowerCase()]?.push({...e,course,bucket});});}});
  DAYS.forEach(d=>{
    const div=document.createElement('div');div.className='day';div.innerHTML=`<h3>${d}</h3>`;const rows=document.createElement('div');rows.className='slots';
    const slots=daySlots[d]||[];slots.sort((a,b)=>{const ma=mins(a.time),mb=mins(b.time);return (ma?.start||0)-(mb?.start||0);});
    let currentTime=null,row=null;
    slots.forEach(s=>{const mt=mins(s.time);const key=mt?mt.start:Math.random();
      if(currentTime!==key){row=document.createElement('div');row.className='row';rows.appendChild(row);currentTime=key;}
      const el=document.createElement('div');el.className='slot';el.innerHTML=`<strong>${s.course}</strong>${s.time}<br>${s.teacher||''} ${s.room?'<br>s.'+s.room:''}`;
      row.appendChild(el);
    });
    div.appendChild(rows);plan.appendChild(div);
  });
}

document.getElementById('parseBtn').onclick=()=>{
  const html=document.getElementById('src').value;const courses=parse(html);
  renderCourses(courses);selections.clear();renderPlan();
};
document.getElementById('search').addEventListener('input',e=>{
  const q=e.target.value.toLowerCase();
  document.querySelectorAll('.course').forEach(card=>{
    const txt=card.textContent.toLowerCase();
    card.style.display=txt.includes(q)?'block':'none';
  });
});
</script>
</body>
</html>
