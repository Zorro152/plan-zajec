<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Plan zajęć – siatka + wybór</title>
<style>
  :root{
    --bd:#e5e7eb; --muted:#6b7280; --accent:#4f46e5;
    --hourHeight: 48px; /* wysokość 1h w siatce */
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7f8;color:#111}
  header{padding:12px 16px;background:#fff;border-bottom:1px solid var(--bd);position:sticky;top:0;z-index:5}
  h1{margin:0;font-size:18px}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
  @media (max-width:960px){ .wrap{grid-template-columns:1fr} }

  /* Lewy panel (lista przedmiotów) */
  .left{display:flex;flex-direction:column;gap:8px}
  .search{padding:8px;border:1px solid var(--bd);border-radius:10px;background:#fff}
  .list{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:8px;max-height:70vh;overflow:auto}
  .course{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--bd);border-radius:10px;padding:8px;margin:6px 0;background:#fafafa}
  .course button{border:0;background:#10b981;color:#fff;border-radius:8px;padding:4px 10px;cursor:pointer}
  .muted{color:var(--muted);font-size:12px}

  /* Prawy panel */
  .right{display:flex;flex-direction:column;gap:12px}

  /* Siatka godzinowa (Excel) */
  .gridWrap{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:8px}
  .gridHeader{display:grid;grid-template-columns:60px repeat(5,1fr);gap:4px;padding:4px 0}
  .gridHeader div{font-size:12px;font-weight:600;text-align:center}
  .gridBody{display:grid;grid-template-columns:60px repeat(5,1fr);gap:4px}
  .times{position:relative}
  .timeCell{height:calc(var(--hourHeight)/2);font-size:11px;color:var(--muted);text-align:right;padding-right:6px;border-right:1px solid var(--bd)}
  .dayCol{position:relative;border-left:1px solid var(--bd);background:
      repeating-linear-gradient(to bottom, transparent, transparent calc(var(--hourHeight)/2 - 1px), rgba(0,0,0,0.05) calc(var(--hourHeight)/2));
      min-height:calc(var(--hourHeight)*6);} /* minimalnie do 14:00 gdyby pusto */
  .event{position:absolute;border:1px solid #c7d2fe;background:#eef2ff;border-radius:8px;padding:4px;font-size:11px;overflow:hidden}
  .event strong{display:block;margin-bottom:2px;font-size:12px}

  /* Wybrane przedmioty – kafelki pod planem */
  .selectedWrap{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:10px}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px}
  .card{border:1px solid var(--bd);border-radius:12px;padding:8px;background:#fafafa}
  .cardHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .chip{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:9999px;padding:2px 8px;font-size:11px}
  .close{border:0;background:#ef4444;color:#fff;border-radius:8px;padding:2px 8px;cursor:pointer}
  fieldset{border:1px solid var(--bd);border-radius:10px;padding:6px;margin:6px 0;background:#fff}
  legend{font-weight:600;font-size:12px}
  .opt{display:flex;gap:8px;align-items:flex-start;margin:4px 0;font-size:13px}
</style>
</head>
<body>
<header><h1>Plan zajęć – siatka + wybór grup</h1></header>

<div class="wrap">
  <!-- LEWA STRONA: tylko wybór przedmiotów (plusik) -->
  <aside class="left">
    <input id="search" class="search" placeholder="Szukaj: nazwa / prowadzący / dzień / godzina..." />
    <div id="courseList" class="list"></div>
    <div class="muted">Wklej źródło (np. same &lt;tr&gt;):</div>
    <input id="src" class="search" placeholder="Wklej tutaj HTML..." />
    <button id="parseBtn" style="padding:8px;border:0;border-radius:10px;background:#4f46e5;color:#fff;cursor:pointer">Parsuj</button>
  </aside>

  <!-- PRAWA STRONA: siatka + kafelki wybranych -->
  <section class="right">
    <div class="gridWrap">
      <div id="gridHeader" class="gridHeader"></div>
      <div id="gridBody" class="gridBody"></div>
    </div>

    <div class="selectedWrap">
      <h3 style="margin:0 0 8px">Wybrane przedmioty</h3>
      <div id="selectedCards" class="cards"></div>
    </div>
  </section>
</div>

<script>
/* ===== Utils & parsing ===== */
const DAYS = ['poniedziałek','wtorek','środa','czwartek','piątek'];
const norm=s=>(s||'').replace(/\s+/g,' ').replace(/—/g,'-').trim();
function htmlToText(node){const d=document.createElement('div');d.innerHTML=node?.innerHTML||'';d.querySelectorAll('a').forEach(a=>a.outerHTML=a.textContent);return norm(d.textContent);}

function parse(html){
  const wrapped=/<tr/i.test(html)&&!/<table/i.test(html)?`<table>${html}</table>`:html;
  const dom=new DOMParser().parseFromString(wrapped,'text/html');
  const rows=[...dom.querySelectorAll('tr')];
  let section=null,current=null;const out=[];
  for(const tr of rows){
    if(tr.classList.contains('top')){section=norm(tr.textContent);continue;}
    const a=tr.querySelector('td[colspan="8"] a');
    if(a){current={name:norm(a.textContent),link:a.href||'',section,entries:[]};out.push(current);continue;}
    const tds=tr.querySelectorAll('td');if(!tds.length)continue;
    const e={group:norm(tds[0]?.textContent),type:norm(tds[1]?.textContent),teacher:norm(tds[2]?.textContent),
             day:norm(tds[3]?.textContent),time:norm(tds[4]?.textContent),room:norm(tds[5]?.textContent),
             uwagi:[tds[6]?htmlToText(tds[6]):'',tds[7]?htmlToText(tds[7]):''].filter(Boolean).join(' | ')};
    const allEmpty=[e.group,e.type,e.teacher,e.day,e.time,e.room,e.uwagi].every(v=>!v||v==='.'); if(allEmpty)continue;
    if(!current){current={name:'Inne',link:'',section,entries:[]};out.push(current);}
    current.entries.push(e);
  }
  return out;
}
function sectionCol(s){const L=(s||'').toLowerCase();if(L.includes('(o)')||L.includes('obowiązkowe'))return 'O';if(L.includes('(m)')||L.includes('zaawansowane'))return 'M';return 'REST';}
function bucketType(t){const v=(t||'').toLowerCase();if(v.startsWith('wyk')||v.startsWith('konw'))return 'wykład';if(v.startsWith('cw'))return 'ćwiczenia';if(v.startsWith('lab'))return 'laboratorium';if(v.startsWith('sem'))return 'seminarium';return 'inne';}
function toMinutes(hhmm){ if(!hhmm) return null;
  const s=hhmm.replace(/[—–]/g,'-').replace(/\s+/g,'').replace(/:/g,'.');
  const m=s.match(/^(\d{1,2})(?:\.(\d{1,2}))?-(\d{1,2})(?:\.(\d{1,2}))?$/);
  const toMin=(h,m)=> (+h)*60 + (+m||0);
  return m?{start:toMin(m[1],m[2]), end:toMin(m[3],m[4])}:null;
}

/* ===== State ===== */
let ALL_COURSES = [];          // wszystkie sparsowane kursy
const SELECTED = new Map();    // courseName -> { wykład: [entries...], ćwiczenia: entry, ... }

/* ===== Left list ===== */
function renderCourseList(){
  const list=document.getElementById('courseList'); list.innerHTML='';
  // sort wg sekcji, potem alfabetycznie
  const sorted=[...ALL_COURSES].sort((a,b)=>sectionCol(a.section).localeCompare(sectionCol(b.section)) || a.name.localeCompare(b.name));
  for(const c of sorted){
    const el=document.createElement('div'); el.className='course';
    el.innerHTML=`<div><strong>${c.name}</strong><div class="muted">${c.section||''}</div></div><button>+</button>`;
    el.querySelector('button').onclick=()=>{ if(!SELECTED.has(c.name)){ SELECTED.set(c.name,{}); renderSelectedCards(); renderGrid(); } };
    list.appendChild(el);
  }
}
document.getElementById('search').addEventListener('input',e=>{
  const q=e.target.value.toLowerCase();
  document.querySelectorAll('#courseList .course').forEach(el=>{
    el.style.display = el.textContent.toLowerCase().includes(q) ? 'flex' : 'none';
  });
});

/* ===== Selected cards (under grid) ===== */
function renderSelectedCards(){
  const wrap=document.getElementById('selectedCards'); wrap.innerHTML='';
  const courses = [...SELECTED.keys()].map(name => ALL_COURSES.find(c=>c.name===name)).filter(Boolean);
  for(const c of courses){
    const byBucket={}; (c.entries||[]).forEach(e=>{const b=bucketType(e.type); (byBucket[b]||(byBucket[b]=[])).push(e);});
    const card=document.createElement('div'); card.className='card';
    const tag = Object.entries(byBucket).map(([k,v])=>`${k}: ${v.length}`).join(' · ');
    card.innerHTML=`
      <div class="cardHead">
        <div><strong>${c.name}</strong> <span class="chip">${tag}</span></div>
        <button class="close">✕</button>
      </div>
      <div class="body"></div>`;
    card.querySelector('.close').onclick=()=>{ SELECTED.delete(c.name); renderSelectedCards(); renderGrid(); };

    const body=card.querySelector('.body');

    // Wykład/konwersatorium – jedna zbiorcza opcja (dodaje WSZYSTKO)
    if(byBucket['wykład']?.length){
      const list=byBucket['wykład'];
      const idBase = Math.random().toString(36).slice(2,8);
      const fs=document.createElement('fieldset'); fs.innerHTML=`
        <legend>wykład/konwersatorium</legend>
        <div class="opt">
          <input type="radio" name="${c.name}_wyklad_${idBase}" id="${idBase}_all">
          <label for="${idBase}_all"><strong>Dodaj wszystkie terminy</strong> <small>(${list.length})</small></label>
        </div>
        <div class="opt">
          <input type="radio" name="${c.name}_wyklad_${idBase}" id="${idBase}_none">
          <label for="${idBase}_none"><em>brak</em></label>
        </div>
        <div class="muted" style="margin-left:22px">
          ${list.map(e=>`• ${[e.teacher,e.day,e.time,e.room&&('s.'+e.room)].filter(Boolean).join(' · ')}`).join('<br>')}
        </div>`;
      fs.querySelector(`#${idBase}_all`).onchange=()=>{ const state=SELECTED.get(c.name)||{}; state['wykład']=list.slice(); SELECTED.set(c.name,state); renderGrid(); };
      fs.querySelector(`#${idBase}_none`).onchange=()=>{ const state=SELECTED.get(c.name)||{}; delete state['wykład']; Object.keys(state).length?SELECTED.set(c.name,state):SELECTED.delete(c.name); renderGrid(); };
      body.appendChild(fs);
    }

    // Ćwiczenia / Laboratorium / Seminarium – jedna ramka, jedna opcja (radio)
    for(const bucket of ['ćwiczenia','laboratorium','seminarium']){
      const list=byBucket[bucket]; if(!list?.length) continue;
      const idBase = Math.random().toString(36).slice(2,8);
      const fs=document.createElement('fieldset'); fs.innerHTML=`<legend>${bucket}</legend>`;
      fs.innerHTML += list.map((e,i)=>`
        <div class="opt">
          <input type="radio" name="${c.name}_${bucket}_${idBase}" id="${idBase}_${i}">
          <label for="${idBase}_${i}">
            ${[e.teacher,e.day,e.time,e.room&&('s.'+e.room),e.group&&('gr.'+e.group)].filter(Boolean).join(' · ')}
            ${e.uwagi?` <small>(${e.uwagi})</small>`:''}
          </label>
        </div>`).join('');
      fs.innerHTML += `
        <div class="opt">
          <input type="radio" name="${c.name}_${bucket}_${idBase}" id="${idBase}_none">
          <label for="${idBase}_none"><em>brak</em></label>
        </div>`;
      fs.querySelectorAll(`input[name="${c.name}_${bucket}_${idBase}"]`).forEach((inp,idx)=>{
        inp.onchange=()=>{
          const state=SELECTED.get(c.name)||{};
          if(inp.id.endsWith('_none')){ delete state[bucket]; Object.keys(state).length?SELECTED.set(c.name,state):SELECTED.delete(c.name); renderGrid(); return; }
          state[bucket]=list[idx]; SELECTED.set(c.name,state); renderGrid();
        };
      });
      body.appendChild(fs);
    }

    wrap.appendChild(card);
  }
}

/* ===== Grid (Excel-like) ===== */
function renderGrid(){
  // zbierz eventy z SELECTED
  const eventsByDay = Object.fromEntries(DAYS.map(d=>[d,[]]));
  SELECTED.forEach((byBucket, course)=>{
    for(const [bucket,val] of Object.entries(byBucket)){
      const entries = Array.isArray(val) ? val : [val];
      entries.forEach(e=>{
        if(!e||!e.day) return;
        const dayKey = DAYS.find(d=>d.toLowerCase() === e.day.toLowerCase()); if(!dayKey) return;
        const tm = toMinutes(e.time) || {start:null,end:null};
        eventsByDay[dayKey].push({
          course, bucket,
          teacher:e.teacher, room:e.room, group:e.group, uwagi:e.uwagi,
          time:e.time, start:tm.start, end:tm.end
        });
      });
    }
  });

  // wyznacz zakres godzin
  let minStart = 8*60; // zawsze co najmniej 8:00
  let maxEnd   = 14*60; // minimalnie do 14:00
  for(const d of DAYS){
    for(const ev of eventsByDay[d]){
      if(ev.start!=null) minStart = Math.min(minStart, ev.start);
      if(ev.end!=null)   maxEnd   = Math.max(maxEnd, ev.end);
    }
  }
  minStart = Math.min(minStart, 8*60);
  const ceilHour = m => Math.ceil(m/60)*60;
  const floorHour = m => Math.floor(m/60)*60;
  minStart = floorHour(minStart);
  maxEnd   = Math.max(ceilHour(maxEnd), 12*60); // co najmniej do 12:00

  const header = document.getElementById('gridHeader');
  const body   = document.getElementById('gridBody');
  header.innerHTML = '';
  body.innerHTML   = '';

  // Header
  header.appendChild(document.createElement('div')); // pusty róg
  DAYS.forEach(d=>{ const cell=document.createElement('div'); cell.textContent=d; header.appendChild(cell); });

  // Kolumna czasu (co 30 min)
  const timesCol = document.createElement('div'); timesCol.className='times';
  for(let m=minStart; m<=maxEnd; m+=30){
    const t=document.createElement('div'); t.className='timeCell';
    t.textContent = (m%60===0) ? String(Math.floor(m/60)).padStart(2,'0')+':00' : '' ;
    timesCol.appendChild(t);
  }
  body.appendChild(timesCol);

  // Dni – puste kolumny
  const totalMinutes = maxEnd - minStart;
  DAYS.forEach(day=>{
    const col = document.createElement('div'); col.className='dayCol';
    col.style.height = `calc(${totalMinutes/60} * var(--hourHeight))`;
    body.appendChild(col);

    // lane assignment (równoległe zajęcia obok siebie)
    const evs = eventsByDay[day].filter(e=>e.start!=null && e.end!=null).sort((a,b)=>a.start-b.start);
    const lanes = []; // każdy lane: {end:number}
    const placed = []; // event -> lane index
    for(const ev of evs){
      let idx = lanes.findIndex(l => l.end <= ev.start);
      if(idx === -1){ idx = lanes.length; lanes.push({end: ev.end}); }
      else { lanes[idx].end = ev.end; }
      placed.push({ev, lane: idx});
    }
    const laneCount = Math.max(1, lanes.length);
    placed.forEach(({ev,lane})=>{
      const top  = ((ev.start - minStart) / totalMinutes) * 100;
      const ht   = ((ev.end   - ev.start) / totalMinutes) * 100;
      const left = (lane / laneCount) * 100;
      const wid  = (1 / laneCount) * 100 - 1; // -1% marginesu
      const box = document.createElement('div'); box.className='event';
      box.style.top = `calc(${top}% - 0px)`;
      box.style.height = `calc(${ht}% )`;
      box.style.left = `calc(${left}% )`;
      box.style.width = `calc(${wid}% )`;
      const meta = [ev.teacher, ev.room&&('s.'+ev.room), ev.group&&('gr.'+ev.group)].filter(Boolean).join(' · ');
      box.innerHTML = `<strong>${ev.course}</strong>${ev.time}<br>${meta}${ev.uwagi?`<br><em>${ev.uwagi}</em>`:''}`;
      col.appendChild(box);
    });
  });
}

/* ===== Wiring ===== */
document.getElementById('parseBtn').onclick=()=>{
  const html=document.getElementById('src').value||'';
  ALL_COURSES = parse(html);
  SELECTED.clear();
  renderCourseList();
  renderSelectedCards();
  renderGrid();
};
</script>
</body>
</html>
