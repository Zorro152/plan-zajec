<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plan zajęć – prosty parser</title>
  <style>
    body{font-family:sans-serif;margin:20px;background:#f7f7f8;color:#111}
    input[type="text"]{width:80%;padding:6px 8px;border:1px solid #ccc;border-radius:8px}
    button{padding:6px 12px;margin-left:8px;border:0;border-radius:8px;background:#4f46e5;color:#fff;cursor:pointer}
    .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:10px;margin:8px 0}
    .row{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:6px;margin:4px 0;font-size:14px}
    details>summary{cursor:pointer;list-style:none;display:flex;gap:6px;align-items:center}
    summary::-webkit-details-marker{display:none}
    .muted{color:#666;font-size:12px}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:9999px;padding:2px 6px;font-size:12px;margin-left:6px}
  </style>
</head>
<body>
  <h1>Plan zajęć – prosty parser</h1>

  <div>
    <input id="src" type="text" placeholder="Wklej tutaj fragment HTML (np. &lt;tr&gt;...&lt;/tr&gt;)" />
    <button id="parseBtn">Parsuj</button>
  </div>

  <div id="status" class="muted" style="margin:10px 0">Gotowe do parsowania.</div>
  <div id="list"></div>

<script>
const srcEl = document.getElementById('src');
const listEl = document.getElementById('list');
const statusEl = document.getElementById('status');

function norm(s){ return (s||'').replace(/\s+/g,' ').replace(/—/g,'-').trim(); }
function htmlToText(node){
  const d = document.createElement('div');
  d.innerHTML = node?.innerHTML || '';
  d.querySelectorAll('a').forEach(a => a.outerHTML = `${a.textContent}${a.href ? ` (${a.href})` : ''}`);
  return norm(d.textContent);
}

function parsePlan(html){
  const wrapped = /<tr[\s>]/i.test(html) && !/<table[\s>]/i.test(html) ? `<table>${html}</table>` : html;
  const dom = new DOMParser().parseFromString(wrapped,'text/html');
  const rows = Array.from(dom.querySelectorAll('tr'));
  const courses=[]; let current=null;

  for(const tr of rows){
    const anchor=tr.querySelector('td[colspan="8"] > a');
    const isHeader=tr.classList.contains('top');
    if(anchor){
      current={ name:norm(anchor.textContent), link:anchor.getAttribute('href')||'', entries:[] };
      courses.push(current); continue;
    }
    if(isHeader) continue;
    const tds=tr.querySelectorAll('td'); if(!tds.length) continue;
    const group=norm(tds[0]?.textContent);
    const type=norm(tds[1]?.textContent);
    const teacher=norm(tds[2]?.textContent);
    const day=norm(tds[3]?.textContent);
    const time=norm(tds[4]?.textContent);
    const room=norm(tds[5]?.textContent);
    const uw1=tds[6]?htmlToText(tds[6]):'';
    const uw2=tds[7]?htmlToText(tds[7]):'';
    const empty=[group,type,teacher,day,time,room,uw1,uw2].every(v=>v===''||v==='.'); if(empty) continue;
    if(!current){ current={name:'Inne',link:'',entries:[]}; courses.push(current); }
    current.entries.push({group,type,teacher,day,time,room,uwagi:[uw1,uw2].filter(Boolean).join(' | ')});
  }
  return courses;
}

function render(courses){
  listEl.innerHTML='';
  if(!courses.length){ listEl.textContent='Brak wyników.'; return; }
  for(const c of courses){
    const details=document.createElement('details');
    details.className='card';
    const counts=c.entries.reduce((a,e)=>{a[e.type||'inne']=(a[e.type||'inne']||0)+1;return a;},{});
    details.innerHTML=`
      <summary>
        <input type="checkbox" />
        <div><strong>${c.name}</strong>
          <span class="pill">${Object.entries(counts).map(([t,n])=>`${t}: ${n}`).join(' · ')}</span>
          ${c.link?`<div class="muted"><a href="${c.link}" target="_blank">USOS</a></div>`:''}
        </div>
      </summary>
      <div style="margin-top:6px">
        ${c.entries.map(e=>`
          <div class="row">
            <div><strong>${e.type||'—'}</strong>${e.group?` · gr. ${e.group}`:''}</div>
            <div>${[e.teacher,e.day,e.time,e.room&&('s. '+e.room)].filter(Boolean).join(' · ')}</div>
            ${e.uwagi?`<div class="muted">${e.uwagi}</div>`:''}
          </div>
        `).join('')}
      </div>
    `;
    listEl.appendChild(details);
  }
}

document.getElementById('parseBtn').onclick=()=>{
  try{
    const courses=parsePlan(srcEl.value||'');
    render(courses);
    statusEl.textContent=`Parsowanie OK. Kursów: ${courses.length}`;
  }catch(e){
    console.error(e);
    statusEl.textContent='Błąd parsowania.';
  }
};
</script>
</body>
</html>
