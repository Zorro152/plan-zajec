<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Plan zajęć – siatka + wybór</title>
<style>
  :root{--bd:#e5e7eb;--muted:#6b7280;--accent:#4f46e5;--hourHeight:48px}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7f8;color:#111}
  header{padding:10px 16px;background:#fff;border-bottom:1px solid var(--bd);position:sticky;top:0;z-index:5}
  h1{margin:0;font-size:18px}
  .btn{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.green{background:#10b981;color:#fff;border:0}
  .btn.red{background:#ef4444;color:#fff;border:0}
  .input{padding:6px 8px;border:1px solid var(--bd);border-radius:10px;background:#fff}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
  @media (max-width:960px){.wrap{grid-template-columns:1fr}}
  .panel{display:flex;flex-direction:column;gap:8px}
  .list{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:8px;max-height:68vh;overflow:auto}
  .sectionTitle{font-weight:600;font-size:13px;margin:8px 0 4px;color:#374151}
  .courseRow{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--bd);border-radius:10px;padding:6px 8px;margin:4px 0;background:#fafafa}
  .muted{color:var(--muted);font-size:12px}
  .right{display:flex;flex-direction:column;gap:12px}
  .gridWrap{position:relative;background:#fff;border:1px solid var(--bd);border-radius:12px;padding:8px}
  .clearPlan{position:absolute;top:8px;right:8px}
  .gridHeader{display:grid;grid-template-columns:60px repeat(5,1fr);gap:4px;padding:4px 0}
  .gridHeader div{font-size:12px;font-weight:600;text-align:center}
  .gridBody{display:grid;grid-template-columns:60px repeat(5,1fr);gap:4px}
  .times{position:relative}
  .timeCell{height:calc(var(--hourHeight)/2);font-size:11px;color:var(--muted);text-align:right;padding-right:6px;border-right:1px solid var(--bd)}
  .dayCol{position:relative;border-left:1px solid var(--bd);background:
      repeating-linear-gradient(to bottom, transparent, transparent calc(var(--hourHeight)/2 - 1px), rgba(0,0,0,0.05) calc(var(--hourHeight)/2));
      min-height:calc(var(--hourHeight)*6)}
  .event{position:absolute;border:1px solid #c7d2fe;background:#eef2ff;border-radius:8px;padding:4px;font-size:11px;overflow:hidden;cursor:pointer}
  .event strong{display:block;margin-bottom:2px;font-size:12px}
  .selectedWrap{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:10px}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px}
  .card{border:1px solid var(--bd);border-radius:12px;padding:8px;background:#fafafa}
  .cardHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .chip{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:9999px;padding:2px 8px;font-size:11px}
  .close{border:0;background:#ef4444;color:#fff;border-radius:8px;padding:2px 8px;cursor:pointer}
  fieldset{border:1px solid var(--bd);border-radius:10px;padding:6px;margin:6px 0;background:#fff}
  legend{font-weight:600;font-size:12px}
  .opt{display:flex;gap:8px;align-items:flex-start;margin:4px 0;font-size:13px}
</style>
</head>
<body>
<header><h1>Plan zajęć – siatka + wybór</h1></header>

<div style="padding:12px 16px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
  <input id="src" class="input" style="width:420px" placeholder="Wklej źródło (np. &lt;tr&gt;...)" />
  <button id="parseBtn" class="btn primary">Parsuj</button>
</div>

<div class="wrap">
  <aside class="panel">
    <input id="search" class="input" placeholder="Szukaj: nazwa / prowadzący / dzień / godzina / sala / uwagi" />
    <div id="courseList" class="list"></div>
  </aside>
  <section class="right">
    <div class="gridWrap">
      <button id="clearAll" class="btn clearPlan">Wyczyść</button>
      <div id="gridHeader" class="gridHeader"></div>
      <div id="gridBody" class="gridBody"></div>
    </div>
    <div class="selectedWrap">
      <h3 style="margin:0 0 8px">Wybrane przedmioty</h3>
      <div id="selectedCards" class="cards"></div>
    </div>
  </section>
</div>

<script>
/* utils + parse (skrócone, jak w poprzedniej wersji) */
const DAYS=['poniedziałek','wtorek','środa','czwartek','piątek'];
const norm=s=>(s||'').replace(/\s+/g,' ').replace(/—/g,'-').trim();
function htmlToText(node){const d=document.createElement('div');d.innerHTML=node?.innerHTML||'';d.querySelectorAll('a').forEach(a=>a.outerHTML=a.textContent);return norm(d.textContent);}
function toMinutes(span){if(!span)return null;const s=span.replace(/[—–]/g,'-').replace(/\s+/g,'').replace(/:/g,'.');const m=s.match(/^(\d{1,2})(?:\.(\d{1,2}))?-(\d{1,2})(?:\.(\d{1,2}))?$/);const toMin=(h,x)=>+h*60+(+x||0);return m?{start:toMin(m[1],m[2]),end:toMin(m[3],m[4])}:null;}
function sectionCol(s){const L=(s||'').toLowerCase();if(L.includes('(o)')||L.includes('obowiązkowe'))return 'O';if(L.includes('(m)')||L.includes('zaawansowane'))return 'M';return 'REST';}
function bucketType(t){const v=(t||'').toLowerCase();if(v.startsWith('wyk')||v.startsWith('konw'))return 'wykład';if(v.startsWith('cw'))return 'ćwiczenia';if(v.startsWith('lab'))return 'laboratorium';if(v.startsWith('sem'))return 'seminarium';return 'inne';}

function parse(html){
  const wrapped=/<tr/i.test(html)&&!/<table/i.test(html)?`<table>${html}</table>`:html;
  const dom=new DOMParser().parseFromString(wrapped,'text/html');
  const rows=[...dom.querySelectorAll('tr')];
  let section=null,current=null;const out=[];
  for(const tr of rows){
    if(tr.classList.contains('top')){section=norm(tr.textContent);continue;}
    const a=tr.querySelector('td[colspan="8"] a');
    if(a){current={name:norm(a.textContent),link:a.getAttribute('href')||'',section,entries:[]};out.push(current);continue;}
    const tds=tr.querySelectorAll('td');if(!tds.length)continue;
    const e={group:norm(tds[0]?.textContent),type:norm(tds[1]?.textContent),teacher:norm(tds[2]?.textContent),
             day:norm(tds[3]?.textContent),time:norm(tds[4]?.textContent),room:norm(tds[5]?.textContent),
             uwagi:[tds[6]?htmlToText(tds[6]):'',tds[7]?htmlToText(tds[7]):''].filter(Boolean).join(' | ')};
    if([e.group,e.type,e.teacher,e.day,e.time,e.room,e.uwagi].every(v=>!v||v==='.'))continue;
    if(!current){current={name:'Inne',link:'',section,entries:[]};out.push(current);}
    current.entries.push(e);
  }
  return out;
}

/* state */
let ALL_COURSES=[]; const SELECTED=new Map(); const COURSE_BY_NAME=new Map();
function buildIndex(courses){COURSE_BY_NAME.clear();courses.forEach(c=>COURSE_BY_NAME.set(c.name,c));}

/* render list with sections and toggle button */
function renderCourseList(){
  const list=document.getElementById('courseList'); list.innerHTML='';
  const q=(document.getElementById('search').value||'').toLowerCase().trim();
  const groups={O:[],M:[],REST:[]};
  ALL_COURSES.forEach(c=>{
    const hay=[c.name,c.section,c.link,...(c.entries||[]).flatMap(e=>[e.type,e.teacher,e.day,e.time,e.room,e.uwagi])].join(' ').toLowerCase();
    if(hay.includes(q)){groups[sectionCol(c.section)].push(c);}
  });
  const order=[['O','Przedmioty obowiązkowe'],['M','Zaawansowane przedmioty'],['REST','Pozostałe']];
  order.forEach(([key,title])=>{
    if(!groups[key].length)return;
    const h=document.createElement('div');h.className='sectionTitle';h.textContent=title;list.appendChild(h);
    groups[key].sort((a,b)=>a.name.localeCompare(b.name)).forEach(c=>{
      const row=document.createElement('div');row.className='courseRow';
      const isSel=SELECTED.has(c.name);
      row.innerHTML=`<div><strong>${c.name}</strong><div class="muted">${c.section||''}</div></div>
        <button class="btn ${isSel?'red':'green'}">${isSel?'✕':'+'}</button>`;
      row.querySelector('button').onclick=()=>{
        if(isSel){removeCourse(c.name);}else{addCourse(c);}
        renderCourseList();
      };
      list.appendChild(row);
    });
  });
}
document.getElementById('search').addEventListener('input',renderCourseList);

/* add/remove (jak w poprzedniej wersji, skrócone) */
function autoSelectIfSingle(course){const byBucket={};(course.entries||[]).forEach(e=>{const b=bucketType(e.type);(byBucket[b]||(byBucket[b]=[])).push(e);});const st=SELECTED.get(course.name)||{};if(byBucket['wykład']?.length)st['wykład']=byBucket['wykład'].slice();if((byBucket['ćwiczenia']||[]).length===1)st['ćwiczenia']=byBucket['ćwiczenia'][0];if((byBucket['laboratorium']||[]).length===1)st['laboratorium']=byBucket['laboratorium'][0];if((byBucket['seminarium']||[]).length===1)st['seminarium']=byBucket['seminarium'][0];SELECTED.set(course.name,st);}
function addCourse(c){if(!SELECTED.has(c.name)){SELECTED.set(c.name,{});autoSelectIfSingle(c);renderSelectedCards();renderGrid();}}
function removeCourse(n){SELECTED.delete(n);renderSelectedCards();renderGrid();}

/* selected cards + grid = identycznie jak w poprzedniej wersji (nie zmieniałem) ... */

/* clear */
function clearAll(){SELECTED.clear();renderSelectedCards();renderGrid();renderCourseList();}

/* wire up */
document.getElementById('parseBtn').onclick=()=>{ALL_COURSES=parse(document.getElementById('src').value||'');buildIndex(ALL_COURSES);SELECTED.clear();renderCourseList();renderSelectedCards();renderGrid();};
document.getElementById('clearAll').onclick=clearAll;
</script>
</body>
</html>
